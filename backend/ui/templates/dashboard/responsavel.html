{% extends 'dashboard/base.html' %}

{% block title %}Dashboard do Responsável{% endblock %}

{% block sidebar_menu %}
  <a class="menu-item is-active" href="#meus-dados">
    <span class="menu-number">01</span>
    <div>
      <strong>Meus Dados</strong>
      <p>Centralize responsáveis e aventureiros</p>
    </div>
  </a>
  <a class="menu-item" href="#dashboard">
    <span class="menu-number">02</span>
    <div>
      <strong>Dashboard</strong>
      <p>Visão rápida das pendências</p>
    </div>
  </a>
  <a class="menu-item" href="#documentos">
    <span class="menu-number">03</span>
    <div>
      <strong>Documentos</strong>
      <p>Ficha médica e termos</p>
    </div>
  </a>
  <span class="menu-item is-disabled">
    <span class="menu-number">04</span>
    <div>
      <strong>Pagamentos</strong>
      <p>Em breve</p>
    </div>
  </span>
  <span class="menu-item is-disabled">
    <span class="menu-number">05</span>
    <div>
      <strong>Eventos</strong>
      <p>Agenda e compromissos</p>
    </div>
  </span>
  <span class="menu-item is-disabled">
    <span class="menu-number">06</span>
    <div>
      <strong>Comunicados</strong>
      <p>Notificações oficiais</p>
    </div>
  </span>
{% endblock %}

{% block content %}
  <section class="dashboard-section" id="dashboard">
    <div class="section-header">
      <p class="section-label">Dashboard</p>
      <h2>Bem-vindo, {{ welcome_name }}</h2>
      <p class="section-subtitle">Acompanhe o fluxo dos aventureiros vinculados ao seu cadastro.</p>
    </div>
    <div class="card-grid">
      <article class="card">
        <h3>Resumo rápido</h3>
        <p class="card-lead">Você tem {{ adventurer_profiles|length }} aventureiro(s) cadastrado(s).</p>
        <div class="status-row">
          <span class="status-pill is-success">Responsável {{ status.responsible }}</span>
          {% if adventurer_profiles %}
            <span class="status-pill is-info">{{ adventurer_profiles|length }} aventureiro(s)</span>
          {% endif %}
        </div>
        <p class="card-note">
          Clique em “Meus Dados” para editar seu cadastro ou o dos aventureiros.
        </p>
      </article>
      <article class="card">
        <h3>Seus aventureiros</h3>
        <ul class="list-snug">
          {% for profile in adventurer_profiles %}
            <li>
              <div>
                <strong>{{ profile.adventurer.name }}</strong>
                <span>{{ profile.adventurer.grade_year }} • {{ profile.adventurer.school }}</span>
              </div>
              <div class="badges-inline">
                <span class="badge badge--{{ profile.medical_class }}">Ficha {{ profile.medical_status }}</span>
                <span class="badge badge--{{ profile.term_class }}">Termo {{ profile.term_status }}</span>
              </div>
            </li>
          {% empty %}
            <li class="empty-state">Nenhum aventureiro cadastrado ainda.</li>
          {% endfor %}
        </ul>
      </article>
      <article class="card">
        <h3>Pendências</h3>
        <ul class="list-snug">
          {% if pendings %}
            {% for pending in pendings %}
              <li>
                <strong>{{ pending.section }}</strong>
                <span>{{ pending.items|join:', ' }}</span>
              </li>
            {% endfor %}
          {% else %}
            <li class="empty-state">Nenhuma pendência detectada (em breve conectaremos a análise automática).</li>
          {% endif %}
        </ul>
      </article>
    </div>
  </section>

  <section class="dashboard-section" id="meus-dados">
    <div class="section-header">
      <p class="section-label">Meus Dados</p>
      <h2>Organize seu cadastro e os dos aventureiros</h2>
      <p class="section-subtitle">Selecione uma pessoa para visualizar detalhes e editar informações.</p>
    </div>
    <div class="people-selector">
      <button type="button" class="person-toggle {% if selected_person == 'responsavel' %}is-active{% endif %}" data-person-trigger="responsavel">
        Meu cadastro
      </button>
      {% for profile in adventurer_profiles %}
        <button type="button" class="person-toggle {% if selected_person == profile.key %}is-active{% endif %}" data-person-trigger="{{ profile.key }}">
          {{ profile.adventurer.name }}
        </button>
      {% endfor %}
    </div>
    <div class="person-details">
      <article class="person-panel {% if selected_person == 'responsavel' %}is-visible{% endif %}" data-person-detail="responsavel">
        <div class="panel-header">
          <h3>Responsável</h3>
          <a class="primary-btn" href="{% url 'cadastro-aventureiro-responsavel' %}">Editar dados do responsável</a>
        </div>
        <div class="panel-grid">
          <div class="panel-card">
            <h4>Dados pessoais</h4>
            <p>Pai: {{ responsible.father_name }} • CPF {{ responsible.father_cpf }}</p>
            <p>Mãe: {{ responsible.mother_name }} • CPF {{ responsible.mother_cpf }}</p>
            <p>Responsável legal: {{ responsible.legal_name }} • CPF {{ responsible.legal_cpf }}</p>
            <p>Usuário: {% if responsible.user %}{{ responsible.user.username }}{% else %}<span class="muted">sem login cadastrado</span>{% endif %}</p>
          </div>
          <div class="panel-card">
            <h4>Contato</h4>
            <p>E-mail pai: {{ responsible.father_email }}</p>
            <p>Celular pai: {{ responsible.father_phone }}</p>
            <p>E-mail mãe: {{ responsible.mother_email }}</p>
            <p>Celular mãe: {{ responsible.mother_phone }}</p>
          </div>
          <div class="panel-card">
            <h4>Endereço</h4>
            <p>{{ responsible.address_line }}, {{ responsible.address_number }}</p>
            <p>{{ responsible.neighborhood }} • {{ responsible.city }} / {{ responsible.state }}</p>
            <p>CEP {{ responsible.cep }}</p>
          </div>
          <div class="panel-card">
            <h4>Outros</h4>
            <p>RG/CIN: {{ responsible.rg_or_cin }}</p>
            <p>Estado civil: {{ responsible.marital_status }}</p>
            <p>Declaração assinada: {{ responsible.declaration_accepted|yesno:'Sim,Não' }}</p>
          </div>
        </div>
      </article>

      {% for profile in adventurer_profiles %}
        <article class="person-panel {% if selected_person == profile.key %}is-visible{% endif %}" data-person-detail="{{ profile.key }}">
          <div class="panel-header">
            <h3>Aventureiro</h3>
            <a class="primary-btn" href="{% url 'cadastro-aventureiro-dados' profile.adventurer.pk %}">Editar dados do aventureiro</a>
          </div>
          <div class="panel-grid">
            <div class="panel-card">
              <h4>Dados pessoais</h4>
              <p>Nome: {{ profile.adventurer.name }}</p>
              <p>Sexo: {{ profile.adventurer.get_sex_display }}</p>
              <p>Data de nascimento: {{ profile.adventurer.birth_date }}</p>
              <p>Classe investida: {{ profile.adventurer.grade_year }}</p>
              <p>Colégio: {{ profile.adventurer.school }}</p>
            </div>
            <div class="panel-card">
              <h4>Documentação</h4>
              <p>Tipo: {{ profile.adventurer.get_document_type_display }}</p>
              <p>Número: {{ profile.adventurer.certificate_number or profile.adventurer.rg_number or profile.adventurer.cin_number or profile.adventurer.cpf_number }}</p>
              <p>Tamanho camiseta: {{ profile.adventurer.tshirt_size }}</p>
            </div>
            <div class="panel-card">
              <h4>Responsável vinculado</h4>
              <p>{{ responsible.legal_name or responsible.father_name }} • {{ responsible.father_phone }}</p>
              <p>{{ responsible.address_line }}, {{ responsible.city }}</p>
            </div>
            <div class="panel-card">
              <h4>Endereço</h4>
              {% if profile.adventurer.use_responsible_address %}
                <p>Usa endereço do responsável</p>
              {% else %}
                <p>{{ profile.adventurer.address_line }}</p>
                <p>{{ profile.adventurer.neighborhood }} • {{ profile.adventurer.city }} / {{ profile.adventurer.state }}</p>
                <p>CEP {{ profile.adventurer.cep }}</p>
              {% endif %}
            </div>
          </div>
          <div class="documents-section"{% if forloop.first %} id="documentos"{% endif %}>
            <div class="documents-header">
              <h4>Documentos</h4>
              <div class="badges-inline">
                <span class="badge badge--{{ profile.medical_class }}">Ficha {{ profile.medical_status }}</span>
                <span class="badge badge--{{ profile.term_class }}">Termo {{ profile.term_status }}</span>
              </div>
            </div>
            {% if profile.medical_pending %}
              <p class="document-note">Precisamos de: {{ profile.medical_pending|join:', ' }}</p>
            {% endif %}
            {% if profile.term_pending %}
              <p class="document-note">Termo: {{ profile.term_pending|join:', ' }}</p>
            {% endif %}
            <div class="document-actions">
              <a class="secondary-btn" href="{% url 'cadastro-aventureiro-ficha' profile.adventurer.pk %}">Ficha Médica</a>
              <a class="secondary-btn" href="{% url 'cadastro-aventureiro-termo' profile.adventurer.pk %}">Termo de Imagem</a>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const triggers = document.querySelectorAll('[data-person-trigger]');
      const panels = document.querySelectorAll('[data-person-detail]');
      const activate = (key) => {
        panels.forEach((panel) => {
          panel.classList.toggle('is-visible', panel.dataset.personDetail === key);
        });
        triggers.forEach((trigger) => {
          trigger.classList.toggle('is-active', trigger.dataset.personTrigger === key);
        });
      };

      triggers.forEach((trigger) => {
        trigger.addEventListener('click', () => {
          activate(trigger.dataset.personTrigger);
        });
      });

      activate('{{ selected_person|escapejs }}');
    });
  </script>
{% endblock %}
