{% extends "cadastro_aventureiro/base.html" %}

{% block stage_content %}
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.photo_data }}
    {{ form.signature_data }}

    <div class="section-card">
      <h4>Dados pessoais</h4>
      <p class="section-note">Renda cada campo com o rótulo e o controle em linha.</p>
      <div class="field-rows">
        {% include 'cadastro_aventureiro/field_row.html' with field=form.name label=form.name.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.sex label=form.sex.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.birth_date label=form.birth_date.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.grade_year label=form.grade_year.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.school label=form.school.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.bolsa_familia label=form.bolsa_familia.label %}
      </div>
    </div>

    <div class="section-card">
      <h4>Classe investida</h4>
      <p class="section-note">Selecione todas as classes já investidas. “Nenhum” deve ser a única opção marcada se for o caso.</p>
      <div class="field-rows invested-wrapper" data-invested-wrapper>
        <div class="field-row">
          <span class="field-row__label">{{ form.invested_class.label }}</span>
          <div class="field-row__control invested-checkboxes">
            {{ form.invested_class }}
          </div>
        </div>
      </div>
    </div>

    <div class="section-card">
      <h4>Documentos</h4>
      <p class="section-note">Preencha apenas os campos referentes ao documento escolhido.</p>
      <div class="field-rows">
        {% include 'cadastro_aventureiro/field_row.html' with field=form.document_type label=form.document_type.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.certificate_number label=form.certificate_number.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.rg_number label=form.rg_number.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.rg_issuer label=form.rg_issuer.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.cin_number label=form.cin_number.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.cpf_number label=form.cpf_number.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.religion label=form.religion.label %}
      </div>
    </div>

    <div class="section-card section-card--stacked">
      <h4>Endereço</h4>
      <p class="section-note">Use o endereço do responsável sempre que possível.</p>
      <div class="field-row">
        <span class="field-row__label">Usar endereço do responsável</span>
        <div class="field-row__control">
          {{ form.use_responsible_address }}
        </div>
      </div>
      <div class="field-rows">
        {% include 'cadastro_aventureiro/field_row.html' with field=form.address_line label=form.address_line.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.neighborhood label=form.neighborhood.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.city label=form.city.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.state label=form.state.label %}
        {% include 'cadastro_aventureiro/field_row.html' with field=form.cep label=form.cep.label %}
      </div>
    </div>

    <div class="section-card">
      <h4>Informações gerais</h4>
      <div class="field-rows">
        {% include 'cadastro_aventureiro/field_row.html' with field=form.tshirt_size label=form.tshirt_size.label %}
      </div>
    </div>

    <div class="section-card">
      <h4>Foto do aventureiro</h4>
      <p>Upload de imagem (qualquer formato). Não bloqueamos por tamanho.</p>
      {{ form.photo.label_tag }} {{ form.photo }}
      <div class="preview-grid">
        <img data-photo-preview src="{{ form.photo_data.value }}" alt="Preview da foto" />
      </div>
    </div>

    <div class="section-card">
      <h4>Assinatura do responsável</h4>
      <div class="signature-area">
        <canvas class="signature-layer" data-signature-target="id_signature_data"></canvas>
        <div class="signature-tools">
          <span>Assine utilizando mouse ou dedo</span>
          <button type="button" data-clear-target>Limpar</button>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="secondary-btn" name="action" value="save_draft" type="submit">Salvar rascunho</button>
      <button class="primary-btn" name="action" value="continue" type="submit">Salvar aventureiro</button>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const investedWrapper = document.querySelector('[data-invested-wrapper]');
        if (!investedWrapper) return;
        const checkboxes = Array.from(investedWrapper.querySelectorAll('input[type="checkbox"]'));
        const noneOption = checkboxes.find((input) => input.value === 'nenhum');

        const syncInvested = (source) => {
          if (!noneOption) return;
          if (source === noneOption && noneOption.checked) {
            checkboxes.forEach((input) => {
              if (input !== noneOption) {
                input.checked = false;
              }
            });
          } else if (noneOption.checked) {
            noneOption.checked = false;
          }
        };

        checkboxes.forEach((input) => {
          input.addEventListener('change', () => syncInvested(input));
        });
      });
    </script>
  </form>
{% endblock %}
